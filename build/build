#!/usr/bin/env bash

# Main build script, intended to run from root of project

# Usage:
	# build [--dest <output path>] [--only app|db] [--db-url <postgres db url>] [--db-path <sqlite db path>] [--db-reset-ok]

# Remarks
	# App build involves typecheckig and bundling client & server app code
	# Db build involves generating db migration script

# Examples:
	# build --dest <path> --db-url <url>  -- Full build to a specifed location, with a targeting a specific db url
	#
	# build --only db --db-reset-ok -- Db build only to ./dist, a targeting the postgres db at DATABASE_URL and/or sqlite db at  DB_PATH
	#
	# build --only app [--dest <path>] -- App only build to a specific output location
#


# Set immediate exit on error (including undefined variables, pipelines)
set -euo pipefail

# Load utility functions
source "$(dirname "$0")/_utils.sh"

# Default values
dest_path="./dist"
db_url="${DATABASE_URL:-}"
db_path="${DB_PATH:-}"
db_reset_ok=false
only=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dest)
            dest_path="$2"
            shift 2
            ;;
        --db-url)
            db_url="$2"
            shift 2
            ;;
		--db-path)
            db_path="$2"
            shift 2
            ;;
        --db-reset-ok)
            db_reset_ok=true
            shift
            ;;
        --only)
            only="$2"
            shift 2
            if [[ "$only" != "app" && "$only" != "db" ]]; then
                print_error "Invalid --only value: $only. Must be 'app' or 'db'"
                exit 1
            fi
            ;;
        *)
            print_error "Unknown argument: $1"
            print_error "Usage: build --dest <path> [--db-url <url>] [--db-path <path>] [--db-reset-ok] [--only app|db]"
            exit 1
            ;;
    esac
done

# Log build arguments
print_step "Build started with args: dest=$dest_path, db-url=$db_url, db-path=$db_path, db-reset-ok=$db_reset_ok, only=$only"

# Create output directories
mkdir -p "$dest_path/public"

# Type check (if not db only)
if [[ "$only" != "db" ]]; then
    print_header "Type-checking..."
    pnpm exec tsc --noEmit --pretty
    print_step "Done type-checking"
fi

# Build client and server code using esbuild config (if not db only)
if [[ "$only" != "db" ]]; then
    print_header "Building client and server..."
    DEST="$dest_path" NODE_ENV="${NODE_ENV:-development}" node esbuild.config.js
    print_step "Done building client and server"
fi

# Copy static client files (if not db only)
if [[ "$only" != "db" ]]; then
    print_header "Staging static files..."
    cp -R ./source/client/static/* "$dest_path/public/"
    print_step "Done staging static files"
fi

# Build database (if not app only)
if [[ "$only" != "app" ]]; then
    # Check if we have database configuration from command line arguments or environment variables
    if [[ -n "$db_url" ]]; then
        print_header "Building PostgreSQL DB..."
        bash "$(dirname "$0")/db/postgres.sh" --dest "$dest_path" --db-url "$db_url" $( [[ "$db_reset_ok" == true ]] && echo "--db-reset-ok" )
        print_step "PostgreSQL DB build completed"
    elif [[ -n "$db_path" ]]; then
        print_header "Building SQLite DB..."

        bash "$(dirname "$0")/db/sqlite.sh" --dest "$dest_path" --db-path "$db_path" $( [[ "$db_reset_ok" == true ]] && echo "--db-reset-ok" )
        echo "SQLite DB build completed"
    else
        print_error "Can't build DB -- no target config specified."
        print_step "Use --db-url <url> or --db-path <path>, or set DATABASE_URL / DB_PATH env variables."
        exit 1
    fi
fi

# print_step "Build completed successfully"