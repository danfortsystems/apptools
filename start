#!/usr/bin/env bash

# Starts the local server with specified database configuration

# Usage:
	# start [--db-url <postgres url>] [--db-path <sqlite path>] [--port <port#>]

# Remarks:
	# The script defaults the --db-url or --db-path argument to the DATABASE_URL/DB_PATH env vars respectively. If neither the arg nor env var is passed/set, the script will raise an error and exit.
	# Server bundle must exist at ./dist/server.bundle.cjs
	# Database migration is run if ./dist/db.migrate.sql exists

# Examples:
	# start --db-url "postgres://localhost:5432/mydb" --port 3000
	# start --db-path "./data/myapp.db" --port 3000
#

# Set immediate exit on error (including undefined variables, pipelines)
set -euo pipefail

# Load utility functions
source "$APPTOOLS_DIR_PATH/_utils"

# Default to environment variables
DB_URL="${DATABASE_URL:-}"
DB_PATH="${DB_PATH:-}"
SERVER_PORT="${PORT:-}"

# Server bundle path
SERVER_BUNDLE="./dist/server.bundle.cjs"


# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --db-url)
            DB_URL="$2"
            shift 2
            ;;
        --db-path)
            DB_PATH="$2"
            shift 2
            ;;
        --port)
            SERVER_PORT="$2"
            shift 2
            ;;
        *)
            print_error "Unknown argument: $1"
            print_error "Usage: start [--db-url <url>] [--db-path <path>] [--port <port#>]"
            exit 1
            ;;
    esac
done

# Validate database configuration
if [[ -z "$DB_URL" && -z "$DB_PATH" ]]; then
    print_error "Neither database URL nor path specified."
    print_error "Use --db-url <url> or --db-path <path>, or set DATABASE_URL / DB_PATH environment variables."
    exit 1
fi

# Validate port
if [[ -z "$SERVER_PORT" ]]; then
    print_error "Neither --port argument nor PORT environment variable is set"
    exit 1
fi

# Log start arguments
print_step "Start arguments:"
if [[ -n "$DB_URL" ]]; then
	print_step "PostgreSQL DB URL: $DB_URL"
elif [[ -n "$DB_PATH" ]]; then
	print_step "SQLite DB path: $DB_PATH"
fi
print_step "Server port: ${SERVER_PORT}\n"

# Check if server bundle exists
if [[ ! -f "$SERVER_BUNDLE" ]]; then
	print_error "Server bundle not found at $SERVER_BUNDLE. Please run 'project build' first."
	exit 1
fi

# Run built db script if present
DB_SCRIPT="./dist/db.migrate.sql"
if [[ -f "$DB_SCRIPT" ]]; then
	print_step "Running init/migration script '$DB_SCRIPT' on DB"

	if [[ -n "$DB_URL" ]]; then
		# PostgreSQL
		if ! psql "$DB_URL" -v ON_ERROR_STOP=1 -v schema=public -f "$DB_SCRIPT"; then
			print_error "PostgreSQL database migration failed. Aborting server start."
			exit 1
		fi
	elif [[ -n "$DB_PATH" ]]; then
		# SQLite
		if ! sqlite3 "$DB_PATH" < "$DB_SCRIPT"; then
			print_error "SQLite database migration failed. Aborting server start."
			exit 1
		fi
	fi

	# Delete db script if it ran successfully
	rm "$DB_SCRIPT"
fi

# Kill any existing process using the target port
# print_step "Checking for existing processes on port $SERVER_PORT..."
EXISTING_PID=$(lsof -ti:$SERVER_PORT 2>/dev/null || true)
if [[ -n "$EXISTING_PID" ]]; then
	print_step "Killing existing process $EXISTING_PID on port $SERVER_PORT..."
	kill -9 $EXISTING_PID 2>/dev/null || true
	sleep 1
fi

# Check if MinIO container is ready when using local object storage
if [[ -n "${OBJECT_STORAGE_ROOT_URL:-}" ]] && [[ "$OBJECT_STORAGE_ROOT_URL" =~ localhost|127\.0\.0\.1 ]]; then
	print_step "Verifying MinIO (local object storage) is ready..."

	if ! ensure_container_ready "minio"; then
		print_error "MinIO container is not ready. Please run the install script first."
		exit 1
	fi

	print_success "MinIO container is ready"
fi

# Check if MailHog container is ready when using local SMTP server
if [[ -n "${SMTP_HOST:-}" ]] && [[ "$SMTP_HOST" =~ localhost|127\.0\.0\.1 ]]; then
	print_step "Verifying MailHog (local email testing) is ready..."

	if ! ensure_container_ready "mailhog"; then
		print_error "MailHog container is not ready. Please run the install script first."
		exit 1
	fi

	print_success "MailHog container is ready"
fi

# Start server with appropriate database configuration
if [[ -n "$DB_URL" ]]; then
	DATABASE_URL=$DB_URL PORT=$SERVER_PORT node "$SERVER_BUNDLE"
elif [[ -n "$DB_PATH" ]]; then
	DB_PATH=$DB_PATH PORT=$SERVER_PORT node "$SERVER_BUNDLE"
fi
