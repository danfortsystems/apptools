// #!/usr/bin/env bun

// import { logMessage, logMessageHeader } from "@danfortsys/loggr"
// import { stringifyError, stringify, objectFromTuples, keys, entries, StdRecord, ReadonlyMaybe } from "@danfortsys/standard"

// import path from "path"
// import { type AuthzStorageRules, effectiveAuthRoleCodes } from "../source/shared/authz/common.ts"
// import { exitWithError, tryWriteFile } from "./_utils"

// import { EntityNamePlural, pluralEntityNames, specs } from "../source/shared/specs/_core.tsx"
// import { Choice, getChoiceValues } from "../source/shared/common.ts"


// (async function main() {
// 	logMessageHeader("Starting authz conversion script...")

// 	// logMessage(`${path.resolve(__dirname, "../source/shared/authz/_storage-rules.generated.ts")}`)
// 	const outputFile = path.resolve(__dirname, "../source/shared/authz/_storage-rules.generated.ts")
// 	const newAuthzRules = convertRules(authzStorageSpecs)

// 	const outputContent = `
// 		// This file is auto-generated by convert-authz.ts. Do not edit manually.

// 		import type { AuthzStorageRules } from "./common"

// 		export const authzStorageRules = ${stringify(newAuthzRules)} satisfies AuthzStorageRules
// 	`

// 	const writeResult = await tryWriteFile(outputFile, outputContent)
// 	if (writeResult.type === "failure") { return exitWithError(`Failed to write to output file: ${stringifyError(writeResult.error)}`) }
// 	logMessageHeader(`Successfully converted authz storage specs to low-level rules in ${outputFile}`)

// })()

// /*function parseScriptArgs(): Result<{ inputFile: string; outputFile: string }> {
// 	try {
// 		const { values } = parseArgs({
// 			options: {
// 				input: {
// 					type: "string",
// 					short: "i",
// 					default: "../source/shared/_authz.json",
// 				},
// 				output: {
// 					type: "string",
// 					short: "o",
// 					default: "../source/shared/_authz.generated.ts",
// 				},
// 			},
// 		})

// 		return ok({
// 			inputFile: resolve(__dirname, values.input!),
// 			outputFile: resolve(__dirname, values.output!),
// 		})
// 	}
// 	catch (error) {
// 		logError("Usage: bun convert-authz.ts [-i <input_file>] [-o <output_file>]")
// 		return stdErrorResultCtors.general({ message: stringifyError(error) })
// 	}
// }*/

// function convertRules(inputAuthzStorageSpecs: typeof authzStorageSpecs): AuthzStorageRules {
// 	const newAuthzRules = {} as AuthzStorageRules<any>


// 	const entityFieldsMap = objectFromTuples(
// 		entries(specs.entities)
// 			.filter(([, entitySpec]) => entitySpec && entitySpec.fields)
// 			.map(([_, entitySpec]) => [entitySpec.namePlural, Object.keys(entitySpec!.fields!)])
// 	) satisfies StdRecord<string[], EntityNamePlural>

// 	for (const specKey of keys(inputAuthzStorageSpecs)) {
// 		const rule = inputAuthzStorageSpecs[specKey]

// 		// const { roles, entities, fields } = rule
// 		const methods = "methods" in rule ? rule.methods : (rule.method ? [rule.method] : [])
// 		const roles = getChoiceValues(rule.roles, effectiveAuthRoleCodes)
// 		const entities = getChoiceValues(rule.entities, pluralEntityNames)

// 		for (const currentRole of roles) {
// 			if (!newAuthzRules[currentRole]) {
// 				newAuthzRules[currentRole] = { canInsert: {}, canGet: {}, canGetX: {}, canModify: {}, canDestroy: [] }
// 			}

// 			for (const method of methods) {
// 				if (method === "destroy") {
// 					newAuthzRules[currentRole]!.canDestroy!.push(...entities)
// 					continue
// 				}

// 				const operation = method === "create" ? "canInsert" : (method === "modify" ? "canModify" : "canGet")

// 				// const fields = 
// 				for (const entity of entities) {
// 					// const fields = getChoiceValues(rule.fields as Choice<string>, entityFieldsMap[entity])
// 					const allowedFields = "fields" in rule ? getChoiceValues(rule.fields as Choice<string>, entityFieldsMap[entity]) : []

// 					if (newAuthzRules[currentRole]![operation]) {
// 						(newAuthzRules[currentRole]![operation] as StdRecord<ReadonlyMaybe<string[]>, string>)[entity] = allowedFields
// 					}
// 				}
// 			}
// 		}
// 	}
// 	return newAuthzRules
// }

